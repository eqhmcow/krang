<script language=javascript>

  function find_story(p) {
        document.forms[0].rm.value = 'save_and_find_story_link';
        document.forms[0].path.value = p;
        document.forms[0].submit();
  }

  function select_story(id) {
        document.forms[0].rm.value = 'select_story';
        document.forms[0].selected_story_id.value = id;
        document.forms[0].submit();
  
  }

  function find_media(p) {
        document.forms[0].rm.value = 'save_and_find_media_link';
        document.forms[0].path.value = p;
        document.forms[0].submit();
  }

  function select_media(id) {
        document.forms[0].rm.value = 'select_media';
        document.forms[0].selected_media_id.value = id;
        document.forms[0].submit();
  }


  function edit_children(p) {
        document.forms[0].rm.value = 'save_and_jump';
        document.forms[0].jump_to.value = p;
        document.forms[0].submit();
  }

  var containers = new Array();
  <tmpl_loop container_loop>
     containers["<tmpl_var name>"] = 1;
  </tmpl_loop>

  function add_child() {
     var list = document.forms[0].child;
     var name = list.options[list.selectedIndex].value;
     if (containers[name]) {
       document.forms[0].rm.value = 'save_and_add';
     } else {
       document.forms[0].rm.value = 'add';
     }
     document.forms[0].submit();
  }

  function jump_to(p) {
     document.forms[0].rm.value = 'save_and_jump';
     document.forms[0].jump_to.value = p;
     document.forms[0].submit();
  }

  function remove_children() {
        if (confirm("Really delete sub-elements?")) {
           document.forms[0].rm.value = 'delete_children';
           document.forms[0].submit();
        }
  }


  function remove_element() {
        if (confirm("Really delete this element?")) {
           document.forms[0].rm.value = 'delete_element';
           document.forms[0].submit();
        }
  }

  function reorder() {
        document.forms[0].rm.value = 'reorder';
        document.forms[0].submit();
  }

  function save_and_change_bulk_edit_sep() {
        document.forms[0].rm.value = 'save_and_change_bulk_edit_sep';
        document.forms[0].submit();
  }

  function checkall(checkbox, prefix) {
     for (var i = 0; i < checkbox.form.elements.length ; i++) {
        var e = checkbox.form.elements[i];
        if (e.name && e.name.indexOf(prefix) == 0) {
           e.checked = checkbox.checked;
        }
     }
  }

// updates the order pull downs to stay consistent
function update_order(obj, prefix) {
    var form  = obj.form;
    var requestedIndex = obj.selectedIndex;
    var i;

    // get list of relevent form elements
    var elem = new Array();
    for (i = 0; i < form.elements.length ; i++) {
        var e = form.elements[i];
        if (e.name && e.name.indexOf(prefix) == 0 && e.options) {
           elem.push(e);
        }
     }

    // sort them by their indexes
    chosenOne = obj;
    elem.sort(update_order_sort_south);

    // did that do it?
    if (elem[requestedIndex] != obj) {
        // the opposite bias must be right 
        elem.sort(update_order_sort_north);
    }

    // walk through the elements handing out indexes
    for (i = 0; i < elem.length; i++) {
        elem[i].selectedIndex = i;
    }
}

// special sort functions that sort by selectedIndex and bias the
// "chosenOne" to either get sorted higher or lower.

var chosenOne;
function update_order_sort_north (a, b) {
    if (a.selectedIndex < b.selectedIndex) { return -1; }
    if (a.selectedIndex > b.selectedIndex) { return  1; }
    if (a == chosenOne) { return -1; }
    if (b == chosenOne) { return 1; }
    return 0;
}
function update_order_sort_south (a, b) {
    if (a.selectedIndex < b.selectedIndex) { return -1; }
    if (a.selectedIndex > b.selectedIndex) { return  1; }
    if (a == chosenOne) { return 1; }
    if (b == chosenOne) { return -1; }
    return 0;
}

</script>

<tmpl_if alert><div class=alert><tmpl_var alert></div></tmpl_if>

  <input type=hidden name=path value="<tmpl_var path>">
  <input type=hidden name=jump_to>
  <input type=hidden name=bulk_edit value="<tmpl_var bulk_edit>">

<tmpl_if find_media_link>

<input type=hidden name=selected_media_id>

Select Media

<tmpl_if crumbs>&nbsp;&nbsp;(<tmpl_loop crumbs><tmpl_if __last__><tmpl_var name><tmpl_else><a href='javascript:jump_to("<tmpl_var path>")'><tmpl_var name></a> &raquo; </tmpl_if></tmpl_loop>)</tmpl_if>

<div class=tight-form-box>

<input type="textfield" name="search_filter" value="<tmpl_var ESCAPE=HTML search_filter>">
<input type="submit" value="Search">

<!-- Krang::HTMLPager params -->
<input type="hidden" name="krang_pager_curr_page_num" value="">
<input type="hidden" name="krang_pager_show_big_view" value="<tmpl_var ESCAPE=HTML krang_pager_show_big_view>">
<input type="hidden" name="krang_pager_sort_field" value="<tmpl_var ESCAPE=HTML krang_pager_sort_field>">
<input type="hidden" name="krang_pager_sort_order_desc" value="<tmpl_var ESCAPE=HTML krang_pager_sort_order_desc>">

</form>

<!-- Krang::HTMLPager -->
<tmpl_var pager_html>
<!-- Krang::HTMLPager -->

</div>
<tmpl_else>

<tmpl_if find_story_link>       

<input type=hidden name=selected_story_id>

Select Story

<tmpl_if crumbs>&nbsp;&nbsp;(<tmpl_loop crumbs><tmpl_if __last__><tmpl_var name><tmpl_else><a href='javascript:jump_to("<tmpl_var path>")'><tmpl_var name></a> &raquo; </tmpl_if></tmpl_loop>)</tmpl_if>

<div class=tight-form-box>

<input type="textfield" name="search_filter" value="<tmpl_var ESCAPE=HTML search_filter>">
<input type="submit" value="Search">

<!-- Krang::HTMLPager params -->
<input type="hidden" name="krang_pager_curr_page_num" value="">
<input type="hidden" name="krang_pager_show_big_view" value="<tmpl_var ESCAPE=HTML krang_pager_show_big_view>">
<input type="hidden" name="krang_pager_sort_field" value="<tmpl_var ESCAPE=HTML krang_pager_sort_field>">
<input type="hidden" name="krang_pager_sort_order_desc" value="<tmpl_var ESCAPE=HTML krang_pager_sort_order_desc>">

</form>

<!-- Krang::HTMLPager -->
<tmpl_var pager_html>
<!-- Krang::HTMLPager -->

</div>

<tmpl_else>

<tmpl_if bulk_edit>

  <input type=hidden name=bulk_edit_child value="<tmpl_var bulk_edit_child>">
  <input type=hidden name=bulk_edit_sep value="<tmpl_var bulk_edit_sep>">

<script language="javascript">
  function update_bulk_edit_counts() {
      var words_span = document.getElementById("bulk_edit_words");
      var chars_span = document.getElementById("bulk_edit_chars");
      var text       = document.forms[0].bulk_data.value;
      var words      = text.split(/\s+/);
      var word_count = 0;
      var char_count = 0;
      var re = /\S/;
      for(var i=0; i < words.length; i++) {
         if (re.test(words[i]) && words[i] != "<tmpl_var bulk_edit_sep>") {
            word_count++;
            char_count += words[i].length;
         }
      }
      words_span.innerHTML = word_count;
      chars_span.innerHTML = char_count;
      setTimeout(update_bulk_edit_counts, 100 + (text.length/10));
  }
  setTimeout(update_bulk_edit_counts, 100);

</script>

Bulk Edit

<tmpl_if crumbs>&nbsp;&nbsp;(<tmpl_loop crumbs><tmpl_if __last__><tmpl_var name><tmpl_else><a href='javascript:jump_to("<tmpl_var path>")'><tmpl_var name></a> &raquo; </tmpl_if></tmpl_loop>)</tmpl_if>

<div class=tight-form-box>
<textarea name=bulk_data rows=20 cols=60><tmpl_var escape=HTML bulk_data></textarea>
</div>

<br>

Separator String
<div class=tight-form-box>
<tmpl_var bulk_edit_sep_selector>
<input type=hidden name=bulk_edit_sep value="<tmpl_var bulk_edit_sep>">
<input type=button value="Change Separator" onclick="save_and_change_bulk_edit_sep()">
</div>

<br>

Statistics
<div class=tight-form-box>
Words: <span id=bulk_edit_words></span> &nbsp;Characters: <span id=bulk_edit_chars></span>
</div>

<tmpl_else>

Content 

<tmpl_if crumbs>&nbsp;&nbsp;&nbsp;&nbsp;(<tmpl_loop crumbs><tmpl_if __last__><tmpl_var name><tmpl_else><a href='javascript:jump_to("<tmpl_var path>")'><tmpl_var name></a> &raquo; </tmpl_if></tmpl_loop>)</tmpl_if>
<br>

<table border=0 width=100% cellpadding=0 cellspacing=0>
  <tr class=form-head>
    <td width=15%>             Element</td>
    <td width=55%>             Data Entry</td>
    <td width=15% align=center>Order</td>
    <td width=15% align=center><input type=checkbox onclick="checkall(this, 'remove_')"></td>
  </tr> 

 <tmpl_loop child_loop>
  <tr>

    <td align=left class="form-cell">
      <tmpl_if required>*</tmpl_if><tmpl_var name>
    </td>

    <td align=left class="form-cell">
      <tmpl_if is_container><input type=button value=Edit onClick='edit_children("<tmpl_var path>")'>&nbsp;</tmpl_if>
      <tmpl_if invalid><span class="invalid"></tmpl_if>
        <tmpl_var form>
      <tmpl_if invalid></span></tmpl_if>
    </td>

    <td align=center class="form-cell">
         <tmpl_var order_select>
    </td>

    <td align=center class="form-cell">
      <tmpl_if allow_delete><input type=checkbox name=remove_<tmpl_var index>><tmpl_else>&nbsp;</tmpl_if>
    </td>

  </tr>
 </tmpl_loop>

 <tmpl_unless child_loop>
   <tr><td colspan=4>No sub-elements defined.</td></tr>
 </tmpl_unless>

   <tr><td align=left colspan=2 class="form-cell">
     <table border=0 cellspacing=1>
      <tmpl_if child_select> 
        <tr><td>
           <tmpl_var child_select>
        </td><td>
           <input type=button value="Add Element" onClick='add_child()'>
        </td><tr>
      </tmpl_if>
      <tmpl_if bulk_edit_select> 
        <tr><td>
          <tmpl_var bulk_edit_select>
        </td><td>
          <input type=button value="Bulk Edit" onClick='save_and_bulk_edit()'>
        </td></tr>           
      </tmpl_if>
     </table>
   </td>
       <td align=center class="form-cell"><input type=button value=Reorder onClick='reorder()'></td>
       <td align=center class="form-cell"><input type=button value=Delete onClick='remove_children()'></td>
   </tr>
</table>

</tmpl_if>

</tmpl_if>
</tmpl_if>