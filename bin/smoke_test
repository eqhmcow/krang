#!/bin/bash
#################################################################
# BASH script used to run the Krang smoke tests
# and upload the results to http://smolder.plusthree.com
# The following Environment variables need to be set
# + TEST_ROOT - the root of the testing setup
# The following Environment variables can be set alter the behaviour
# + KRANG_SMOLDER_CATEGORY - set the category for this upload to smolder
#################################################################

export KRANG_ROOT=$TEST_ROOT/svn
export KRANG_INSTANCE=test1

# upload the krang tests results to smolder
function krang_results_to_smolder {
        cd $TEST_ROOT
        perl -I$KRANG_ROOT/lib -I$KRANG_ROOT/lib/i686-linux $TEST_ROOT/smolder_smoke_signal \
                --server 'smolder.plusthree.com' \
                --project 'Krang' \
                --username 'autobot' \
                --password 'XXXX' \
                --file "$KRANG_ROOT/krang_test_run.tar.gz" \
                --architecture "`uname -m`" \
                --platform "`cat /etc/redhat-release`"
                --category "$KRANG_SMOLDER_CATEGORY"
}

# don't run the tests if we're already running
cd $TEST_ROOT
if ls tests_running 2>/dev/null
then
        echo "Tests are currently running. Exiting."
        exit
fi

# don't let another run go while we're going
touch tests_running

cd $KRANG_ROOT

# get the latest Krang from SVN
if svn update | grep 'Updated to'
then
        # stop any possible previous runs
        bin/krang_ctl stop

        # gives us a clean slate to start
        bin/krang_build --with-ssl --rebuild
        bin/krang_createdb --destroy --no_prompt test1
        bin/krang_createdb --destroy --no_prompt test2

        # run the test
        make restart
        make test_archive
        sudo bin/krang_ctl stop

        # now send the results off to smolder
        krang_results_to_smolder
else
        echo "No updates to Krang"
fi

# cleanup after ourselves for the next run
cd $TEST_ROOT
rm -f tests_running
