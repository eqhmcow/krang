<tmpl_include /header.tmpl>


<script language="Javascript">
<!-- //

    <tmpl_var js_list_arrays>

    var new_count = 1;
    var change_log = new Array();

    function populate_list (list_count,sel_in_list,no_clear) {
        var next_list = list_count + 1;

        // first, clear lists above one selected
        if ( ! no_clear) {
            clear_lists_above(next_list);
        }

        if ( list_count != 0 ) {
            var select_val = get_selected_val(list_count);
        
            var count = 0;
            for(var key in eval('list_data[' + select_val + ']') ) {
                if (eval('list_data[' + select_val + "][key]['__data__']") ) {
                    eval ('document.forms["edit_form"].list_' + next_list + '.options[' + count++ + '] = new Option(' + "'" + eval("list_data[" + select_val + "][key]['__data__']") + "', '" + select_val + '][' + key + "')");
                }
            }
        } else {
            var count = 0;
            for(var key in list_data) {
               if (list_data[key]['__data__']) {
                    eval ('document.forms["edit_form"].list_1.options[' + count++ + '] = new Option(' + "'" + eval("list_data[key]['__data__']") +  "', '" + key + "')"); 
               }
            }
        }
        if (sel_in_list > -1) {
            eval( 'document.forms["edit_form"].list_' + next_list + '.selectedIndex = sel_in_list');
        }
    }

    function clear_lists_above(list_count) {
        for ( var c = list_count; c <= <tmpl_var list_levels>; c++ ) {
            eval ('document.forms["edit_form"].list_' + c + '.options.length = 0'); 
        }
    }

    function get_selected_val (list_count) {
        var sindex = eval( 'document.forms["edit_form"].list_' + list_count + '.selectedIndex' );
        if (sindex > -1) {
            return eval ('document.forms["edit_form"].list_' + list_count + '.options[' + sindex + '].value');
        } else {
            return('undef');
        }
    };

    function get_list_id (list_count) {
        var lid = eval( 'document.forms["edit_form"].list_id_' + list_count + '.value' );
        return lid; 
    }

    nav_edit_mode();

    function do_save () {
        var myform = document.forms["edit_form"];
        myform.rm.value = "save";
        var change_string = change_log.join('%^%');
        myform.changes.value = change_string;
        myform.submit();
    }


    function save_stay () {
        var myform = document.forms["edit_form"];
        myform.rm.value = "save_stay";
        myform.submit();
    }


    function do_delete (list_count) {
        var select_val = get_selected_val(list_count);
        log_entry( eval('list_data[' + select_val + "]['__id__']"), 'delete', '');
        eval('list_data[' + select_val + "]['__data__'] = []");
        eval('list_data[' + select_val + '] = []');
        populate_list(list_count-1);
    }

    function do_replace(list_count) {
        var select_val = get_selected_val(list_count);
        if ( eval("document.forms['edit_form'].new_item_" + list_count + ".value" ) ) {
            var item = eval( 'list_data[' + select_val + ']');
            var nv = eval( "document.forms['edit_form'].new_item_" + list_count + ".value" );
            item['__data__'] = nv;
            var indexArray = select_val.split('][');
            var last_index = indexArray.pop();
            populate_list(list_count-1, last_index, 1);
            eval( "document.forms['edit_form'].new_item_" + list_count + ".value = ''");
            log_entry(item['__id__'], 'replace', nv);
        }
    }

    function do_move(list_count, down) {
        var select_val = get_selected_val(list_count);
        var last_index;
        if (select_val != 'undef' ) {
            var indexArray = select_val.split('][');
            last_index = indexArray.pop();
            select_val = indexArray.join('][');
            var firstHalf;
            var secondHalf;
            if (down) {
                last_index = parseInt(last_index) + 1;
            } else {
                if (last_index == 0) {
                    return;
                } 
            }
            if (! select_val) {
                firstHalf = list_data.slice(0, last_index);
                secondHalf = list_data.slice(last_index);
            } else {
                firstHalf = eval('list_data[' + select_val + '].slice(0,last_index)');
                secondHalf = eval('list_data[' + select_val + '].slice(last_index)');
            }
            if (down && (secondHalf.length == 0)) {
                return;
            }
            var prev = firstHalf.pop();
            var current = secondHalf.shift();

            // log this change           
            if (down) {
                log_entry(prev['__id__'], 'move', parseInt(last_index) + 1);
            } else {
                log_entry(current['__id__'], 'move', parseInt(last_index));
            }
 
            firstHalf.push(current);
            secondHalf.unshift(prev);
        
            if (! select_val) {
                list_data = firstHalf.concat(secondHalf);
            } else {
                eval('list_data[' + select_val + '] = firstHalf.concat(secondHalf)');
            }
        }
        if (! down) {
            last_index--;
        } 
        populate_list((list_count-1), last_index, 1);
    }

    function do_add(list_count) {
        var select_val = get_selected_val(list_count);
        var new_data = eval( "document.forms['edit_form'].new_item_" + list_count + ".value" );
        if (select_val != 'undef' ) {
            var indexArray = select_val.split('][');
            var last_index = indexArray.pop();
            select_val = indexArray.join('][');
            var firstHalf;
            var secondHalf;
            if (! select_val) {
                firstHalf = list_data.slice(0, last_index);
                secondHalf = list_data.slice(last_index);
            } else {
                firstHalf = eval('list_data[' + select_val + '].slice(0, last_index)');
                secondHalf = eval('list_data[' + select_val + '].slice(last_index)');
            }

            var t = new Array();
            t['__data__'] = new_data;
            t['__id__'] = 'new_' + new_count++;
            var parent;
            if (indexArray.length) {
                parent = eval("list_data[" + select_val + "]['__id__']");
            }
            log_entry(t['__id__'], 'new', t['__data__'] + '^*^' + (parseInt(last_index) + 1) + '^*^' + get_list_id(list_count) + '^*^' + parent );
            secondHalf.unshift(t);
            if (! select_val) {
                list_data = firstHalf.concat(secondHalf);
            } else {
                eval('list_data[' + select_val + '] = firstHalf.concat(secondHalf)');
            } 
        } else {
            if (list_count - 1) {
                select_val = get_selected_val(list_count - 1);
            } else {
                 select_val = 'undef';
            }

            if (select_val == 'undef') {
                if( ! list_data[0]) {
                    list_data[0] = new Array();
                    list_data[0]['__data__'] = new_data;
                    list_data[0]['__id__'] = 'new_' + new_count++;
                    log_entry(list_data[0]['__id__'], 'new', list_data[0]['__data__'] + '^*^' + 1 + '^*^' + get_list_id(list_count) );
                } else {
                    var nitem = new Array();
                    nitem['__data__'] = new_data;
                    nitem['__id__'] = 'new_' + new_count++;
                    list_data.splice(0,0,nitem);
                    log_entry(nitem['__id__'], 'new', nitem['__data__'] + '^*^' + 1 + '^*^' + get_list_id(list_count) );
                }
            } else { 
                if( ! eval('list_data[' + select_val + '][0]') ) {
                    eval('list_data[' + select_val + '][0] = new Array()');
                    var it = eval('list_data[' + select_val + '][0]');
                    eval( "list_data[" + select_val + "][0]['__data__'] = document.forms['edit_form'].new_item_" + list_count + ".value" ); 
                    it['__id__'] = "new_" + new_count++;
                    log_entry(it['__id__'], 'new', it['__data__'] + '^*^'
+ 1 + '^*^' + get_list_id(list_count) + '^*^' + eval('list_data[' + select_val + "]['__id__']"));
                } else {
                    var nitem = new Array();
                    nitem['__data__'] = new_data;
                    nitem['__id__'] = 'new_' + new_count++;
                    eval('list_data[' + select_val + '].splice(0,0,nitem)');
                    log_entry(nitem['__id__'], 'new', nitem['__data__'] + '^*^' + 1 + '^*^' + get_list_id(list_count) + '^*^' + eval('list_data[' + select_val + ']["__id__"]'));
                }
            }
            last_index = 0;
        }
        
        eval( "document.forms['edit_form'].new_item_" + list_count + ".value = ''" );
        populate_list(list_count-1, last_index);
    }

    function log_entry (item_id, action, data) {
        var entry;
        entry = item_id + '#&#' + action + '#&#' + data;
        change_log.push(entry);
    }
    
// -->
</script>


<table border="0" cellpadding="2" cellspacing="0" width="100%">
<tr class="dark-bar">
  <td>&nbsp;LIST GROUP EDIT - <tmpl_var list_group_name></td>
  <td align="right"><a href="javascript:goto_help()">Help</a>&nbsp;</td>
</tr>
</table>

<form name="edit_form" method="GET" action="list_group.pl">
<input type="hidden" name="rm" overwrite="1">
<input type="hidden" name="changes" overwrite="1">
<table border="1" cellpadding="2" cellspacing="0" width="100%">
<tr><td width="150">Description:</td><td width="400"><textarea rows="4" cols="60"><tmpl_var list_group_description></textarea></td></tr>
<tr class="light-bar"><td colspan=2>LISTS</td></tr>
<tmpl_loop list_loop>
<tr><td><tmpl_var list_name></td><td><input type='hidden' name="list_id_<tmpl_var list_count>" value="<tmpl_var list_id>"><select name="list_<tmpl_var list_count>" size="10" onChange="populate_list(<tmpl_var list_count>)">
<tmpl_if list_item_loop><tmpl_loop list_item_loop><option value="<tmpl_var order>"><tmpl_var data></tmpl_loop></tmpl_if></select>
<br>&nbsp;&nbsp;&nbsp;&nbsp;<a href="javascript:do_move(<tmpl_var list_count>, 1)"><img src="images/arrow-asc.gif" border="0"></a>
<a href="javascript:do_move(<tmpl_var list_count>)"><img src="images/arrow-desc.gif" border="0"></a>
<br><input type="text" name="new_item_<tmpl_var list_count>">
<input type="button" value="Add" onClick="do_add(<tmpl_var list_count>)" class="button">
<input type="button" value="Replace" onClick="do_replace(<tmpl_var list_count>)" class="button">
<input type="button" value="Delete Selected" onClick="do_delete(<tmpl_var list_count>)" class="button">
</td></tr>
</tmpl_loop>
</table>
<div class="button-bar">
    <input type="submit" value="Save" onClick="do_save()" class="button">
    <input type="button" value="Save &amp; Stay" onClick="save_stay()" class="button">
</div>


<!-- End edit_form -->
</form>


<tmpl_include /footer.tmpl>
