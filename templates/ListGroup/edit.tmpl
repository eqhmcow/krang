<tmpl_include /header.tmpl>


<script language="Javascript">
<!-- //

    <tmpl_var js_list_arrays>

    var new_count = 1;
    var change_log = new Array();

    nav_edit_mode();
                                                                               
    function do_save () {
        var myform = document.forms["edit_form"];
        myform.rm.value = "save";
        var change_string = change_log.join('%^%');
        myform.changes.value = change_string;
        myform.submit();
    }
                                                                               
                                                                               
    function do_save_stay () {
        var myform = document.forms["edit_form"];
        myform.rm.value = "save";
        var change_string = change_log.join('%^%');
        myform.changes.value = change_string;
        myform.stay.value = 1;
        myform.submit();
    }

    function populate_list (list_count,sel_in_list,no_clear) {
        var next_list = list_count + 1;

        // first, clear lists above one selected
        if ( ! no_clear) {
            clear_lists_above(next_list);
        }

        if ( list_count != 0 ) {
            var select_val = get_selected_val(list_count);
        
            var count = 0;
            for(var key in eval('list_data[' + select_val + ']') ) {
                if (eval('list_data[' + select_val + "]")[key]['__data__']) {
                    var new_val = eval("list_data[" + select_val + "]")[key]['__data__'];
                    new_val = new_val.replace(/\"/g, '``');
                    eval ('document.forms["edit_form"].list_' + next_list + '.options[' + count++ + '] = new Option(' + '"' + new_val + '", "' + select_val + '][' + key + '")');
                }
            }
        } else {
            var count = 0;
            for(var key in list_data) {
               if (list_data[key]['__data__']) {
                   var new_val = list_data[key]['__data__'];
                    new_val = new_val.replace(/\"/g, '``');
                   document.forms["edit_form"].list_1.options[count++] = new Option(new_val , key); 
               }
            }
        }
        if (sel_in_list > -1) {
            eval( 'document.forms["edit_form"].list_' + next_list).selectedIndex = sel_in_list;
        }
    }

    function clear_lists_above(list_count) {
        for ( var c = list_count; c <= <tmpl_var list_levels>; c++ ) {
            eval ('document.forms["edit_form"].list_' + c).options.length = 0; 
        }
    }

    function get_selected_val (list_count) {
        var sindex = eval( 'document.forms["edit_form"].list_' + list_count).selectedIndex;
        if (sindex > -1) {
            return eval ('document.forms["edit_form"].list_' + list_count).options[sindex].value;
        } else {
            return('undef');
        }
    };

    function get_list_id (list_count) {
        var lid = eval( 'document.forms["edit_form"].list_id_' + list_count).value;
        return lid; 
    }

    function do_delete (list_count) {
        var select_val = get_selected_val(list_count);
        log_entry( eval('list_data[' + select_val + "]['__id__']"), 'delete', '');
        var indexArray = select_val.split('][');
        var current_index = indexArray.pop();
        select_val = indexArray.join('][');
        if (! select_val) {
            list_data.splice(current_index, 1);
        } else {
            // else this is not first list
            eval('list_data[' + select_val + ']').splice(current_index, 1);
        }
        populate_list(list_count-1);
    }

    function do_replace(list_count) {
        var select_val = get_selected_val(list_count);
        if ( eval("document.forms['edit_form'].new_item_" + list_count).value ) {
            var item = eval( 'list_data[' + select_val + ']');
            var nv = eval( "document.forms['edit_form'].new_item_" + list_count).value;
            item['__data__'] = nv;
            var indexArray = select_val.split('][');
            var current_index = indexArray.pop();
            populate_list(list_count-1, current_index, 1);
            eval( "document.forms['edit_form'].new_item_" + list_count).value = '';
            log_entry(item['__id__'], 'replace', nv);
        }
    }

    function do_move(list_count, down) {
        var select_val = get_selected_val(list_count);
        var current_index;
        if (select_val != 'undef' ) {
            var indexArray = select_val.split('][');
            current_index = indexArray.pop();
            select_val = indexArray.join('][');
            var firstHalf;
            var secondHalf;
            // if moving down, up current index
            if (down) {
                current_index = parseInt(current_index) + 1;
            } else {
                // if on first index and trying to move up do nothing
                if (current_index == 0) {
                    return;
                } 
            }
            if (! select_val) {
                firstHalf = list_data.slice(0, current_index);
                secondHalf = list_data.slice(current_index);
            } else {
                firstHalf = eval( 'list_data[' + select_val + ']').slice(0, current_index);
                secondHalf = eval( 'list_data[' + select_val + ']').slice(current_index);
            }
            if (down && (secondHalf.length == 0)) {
                return;
            }
            var prev = firstHalf.pop();
            var current = secondHalf.shift();

            // log this change           
            if (down) {
                log_entry(prev['__id__'], 'move', parseInt(current_index) + 1);
            } else {
                log_entry(current['__id__'], 'move', parseInt(current_index));
            }
 
            firstHalf.push(current);
            secondHalf.unshift(prev);
        
            if (! select_val) {
                list_data = firstHalf.concat(secondHalf);
            } else {
                eval( 'list_data[' + select_val + '] = firstHalf.concat(secondHalf)' );
            }

            if (! down) {
                current_index--;
            }
            populate_list((list_count-1), current_index, 1);

        }
    }

    function do_add(list_count) {
        var select_val = get_selected_val(list_count);
        var new_data = eval( "document.forms['edit_form'].new_item_" + list_count).value;

        // do nothing if no value is entered in textbox
        if (! new_data) {
            return;
        }
 
        if (list_count != 1) {
            var rlc = list_count - 1;
           for(var key in list_data[rlc]) {
               if (list_data[rlc][key]['__data__'] == new_data) {
                    alert("'" + new_data  + "'" + " is already an item in this list. Not added.");
                    return;
                }
            }
        } else { 
            for(var key in list_data) {
               if (list_data[key]['__data__'] == new_data) {
                    alert("'" + new_data  + "'" + " is already an item in this list. Not added.");
                    return;
                }
            }
        }

        // if list item is selected in list we are adding to
        if (select_val != 'undef' ) {
            var indexArray = select_val.split('][');
            var current_index = indexArray.pop();
            select_val = indexArray.join('][');
            
            var t = new Array();
            t['__data__'] = new_data;
            t['__id__'] = 'new_' + new_count++;

            // if we are on the first list
            if (! select_val) {
                list_data.splice(current_index, 0, t);
            } else {
                // else this is not first list
                eval('list_data[' + select_val + ']').splice(current_index, 0, t);
            }

            var parent;
            if (indexArray.length) {
                parent = eval("list_data[" + select_val + "]")['__id__'];
            }
            log_entry(t['__id__'], 'new', new_data + '^*^' + (parseInt(current_index) + 1) + '^*^' + get_list_id(list_count) + '^*^' + parent );
        } else {
            // if this is not the first list, get the parent selected
            if (list_count - 1) {
                select_val = get_selected_val(list_count - 1);
        
                // if parent isn't selected either, dont do a thing
                if (select_val == 'undef') {
                    return;
                }
            } else {
                 select_val = 'undef';
            }

            // if this is first list
            if (select_val == 'undef') {
                // if this is first item in first list
                if( ! list_data[0]) {
                    list_data[0] = new Array();
                    list_data[0]['__data__'] = new_data;
                    list_data[0]['__id__'] = 'new_' + new_count++;
                    log_entry(list_data[0]['__id__'], 'new', list_data[0]['__data__'] + '^*^' + 1 + '^*^' + get_list_id(list_count) );
                } else {
                    // else add as first item in first list
                    var nitem = new Array();
                    nitem['__data__'] = new_data;
                    nitem['__id__'] = 'new_' + new_count++;
                    list_data.splice(0,0,nitem);
                    log_entry(nitem['__id__'], 'new', new_data + '^*^' + 1 + '^*^' + get_list_id(list_count) );
                }
            } else { 
                // if this list has no current items
                if( ! eval('list_data[' + select_val + ']')[0] ) {
                    eval('list_data[' + select_val + ']')[0] = new Array();
                    var it = eval('list_data[' + select_val + ']')[0];
                    it['__data__'] = new_data; 
                    it['__id__'] = "new_" + new_count++;
                    log_entry(it['__id__'], 'new', new_data + '^*^'
+ 1 + '^*^' + get_list_id(list_count) + '^*^' + eval('list_data[' + select_val + ']')['__id__']);
                } else {
                    var nitem = new Array();
                    nitem['__data__'] = new_data;
                    nitem['__id__'] = 'new_' + new_count++;
                    eval('list_data[' + select_val + ']').splice(0,0,nitem);
                    log_entry(nitem['__id__'], 'new', new_data + '^*^' + 1 + '^*^' + get_list_id(list_count) + '^*^' + eval('list_data[' + select_val + ']')["__id__"]);
                }
            }
            current_index = 0;
        }
        
        eval( "document.forms['edit_form'].new_item_" + list_count).value = '';
        populate_list(list_count-1, current_index);
    }

    function log_entry (item_id, action, data) {
        var entry;
        entry = item_id + '#&#' + action + '#&#' + data;
        change_log.push(entry);
    }
    
// -->
</script>

<form name="edit_form" method="POST" action="list_group.pl">
<input type="hidden" name="list_group_id" value="<tmpl_var list_group_id>" overwrite="1">
<input type="hidden" name="rm" overwrite="1">
<input type="hidden" name="changes" overwrite="1">
<input type="hidden" name="stay" overwrite="1">


<table border="0" cellpadding="2" cellspacing="0" width="100%">
<tr class="dark-bar">
  <td>&nbsp;List Group Edit</td>
  <td align="right"><a href="javascript:goto_help()">Help</a>&nbsp;</td>
</tr>
</table>

<table border="0" cellpadding="2" cellspacing="0" width="100%">
<tr><td width="150" class=form-cell>Group Name:</td>
<td class=form-cell><tmpl_var list_group_name></td></tr>
<tr><td width="150" class=form-cell>Description:</td>
<td class=form-cell><textarea name="list_group_description" rows="2" cols="30"><tmpl_var list_group_description></textarea></td></tr>
</table>
<p>

<div class="light-bar">Lists</div>
<table border="0" cellpadding="2" cellspacing="0" width="100%">
<tmpl_loop list_loop>
<tr><td class=form-cell width=150><tmpl_var list_name>:</td>
<td class=form-cell><input type='hidden' name="list_id_<tmpl_var list_count>" value="<tmpl_var list_id>"><select name="list_<tmpl_var list_count>" size="10" onChange="populate_list(<tmpl_var list_count>)">
<tmpl_if list_item_loop><tmpl_loop list_item_loop><option value="<tmpl_var order>"><tmpl_var data></tmpl_loop></tmpl_if></select>
<br>&nbsp;&nbsp;&nbsp;&nbsp;<a href="javascript:do_move(<tmpl_var list_count>, 1)"><img src="images/arrow-asc.gif" border="0"></a>
<a href="javascript:do_move(<tmpl_var list_count>)"><img src="images/arrow-desc.gif" border="0"></a>
<br><input type="text" name="new_item_<tmpl_var list_count>">
<input type="button" value="Add" onClick="do_add(<tmpl_var list_count>)" class="button">
<input type="button" value="Replace" onClick="do_replace(<tmpl_var list_count>)" class="button">
<input type="button" value="Delete Selected" onClick="do_delete(<tmpl_var list_count>)" class="button">
</td></tr>
</tmpl_loop>
</table>

<div class="button-bar">
    <input type="submit" value="Save" onClick="do_save()" class="button">
    <input type="button" value="Save &amp; Stay" onClick="do_save_stay()" class="button">
</div>


<!-- End edit_form -->
</form>

</div>

<tmpl_include /footer.tmpl>
